<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件&用户管理系统</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 30px;
        }
        .tab-bar {
            background-color: white;
            padding: 0 30px;
            border-bottom: 1px solid #e1e4e8;
        }
        .tab-bar li {
            display: inline-block;
            padding: 15px 20px;
            cursor: pointer;
        }
        .tab-bar li.active {
            border-bottom: 2px solid #3498db;
            color: #3498db;
        }
        .operation-bar {
            background-color: white;
            padding: 20px 30px;
            margin: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
        }
        .list-container {
            margin: 0 20px;
            background-color: white;
            border-radius: 8px;
            display: none;
        }
        .list-container.active {
            display: block;
        }
        .list-table {
            width: 100%;
            border-collapse: collapse;
        }
        .list-table th, .list-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f0f2f5;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            width: 500px;
        }
        .file-input {
            padding: 20px;
            border: 2px dashed #e1e4e8;
            border-radius: 4px;
            text-align: center;
            margin: 15px 0;
            cursor: pointer;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        .btn-close {
            background-color: #95a5a6;
            color: white;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 9999;
        }
        .toast-success {
            background-color: #2ecc71;
        }
        .toast-error {
            background-color: #e74c3c;
        }
        .toast-warning {
            background-color: #f39c12;
        }
        .empty-data {
            text-align: center;
            color: #999;
            padding: 40px 0;
        }
        #pageControl {
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
<!-- 头部 -->
<div class="header">
    <h1>文件&用户管理系统</h1>
</div>

<!-- 标签页 -->
<div class="tab-bar">
    <ul>
        <li class="active" onclick="switchTab('file-tab')">文件管理</li>
        <li onclick="switchTab('user-tab')">用户管理</li>
    </ul>
</div>

<!-- 文件操作栏 -->
<div class="operation-bar" id="file-operation">
    <div class="search-box">
        <input type="text" id="fileSearchInput" placeholder="请输入文件名搜索">
        <button class="btn btn-primary" onclick="searchFile()">搜索</button>
    </div>
    <button class="btn btn-success" onclick="openUploadModal()">上传文件</button>
</div>

<!-- 用户操作栏 -->
<div class="operation-bar" id="user-operation" style="display: none;">
    <div class="search-box">
        <input type="text" id="userSearchInput" placeholder="请输入用户名搜索">
        <button class="btn btn-primary" onclick="searchUser()">搜索</button>
    </div>
    <button class="btn btn-success" onclick="openUserModal()">新增用户</button>
</div>

<!-- 文件列表 -->
<div class="list-container active" id="file-container">
    <table class="list-table" id="fileTable">
        <thead>
        <tr>
            <th>文件名</th>
            <th>类型</th>
            <th>大小</th>
            <th>上传时间</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody id="fileTableBody">
        <tr>
            <td colspan="5" class="empty-data">加载中...</td>
        </tr>
        </tbody>
    </table>
</div>

<!-- 用户列表 -->
<div class="list-container" id="user-container">
    <table class="list-table" id="userTable">
        <thead>
        <tr>
            <th>ID</th>
            <th>用户名</th>
            <th>年龄</th>
            <th>手机号</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody id="userTableBody">
        <tr>
            <td colspan="5" class="empty-data">加载中...</td>
        </tr>
        </tbody>
    </table>
    <div id="pageControl"></div>
</div>

<!-- 上传弹窗 -->
<div class="modal" id="uploadModal">
    <div class="modal-content">
        <h3>上传文件</h3>
        <div class="file-input" onclick="document.getElementById('fileInput').click()">
            <p>点击选择文件（支持txt/pdf/docx/png/jpg）</p>
            <p id="fileNameTip">未选择文件</p>
        </div>
        <input type="file" id="fileInput" accept=".txt,.pdf,.docx,.png,.jpg" onchange="showFileName()">
        <div class="modal-footer">
            <button class="btn btn-close" onclick="closeModal('uploadModal')">取消</button>
            <button class="btn btn-primary" onclick="uploadFile()">确认上传</button>
        </div>
    </div>
</div>

<!-- 用户弹窗 -->
<div class="modal" id="userModal">
    <div class="modal-content">
        <h3 id="userModalTitle">新增用户</h3>
        <input type="hidden" id="userId">
        <div style="margin: 15px 0;">
            <label>用户名：</label>
            <input type="text" id="userName" placeholder="请输入用户名" style="width: 100%; padding: 8px; margin-top: 5px;">
        </div>
        <div style="margin: 15px 0;">
            <label>年龄：</label>
            <input type="number" id="userAge" placeholder="请输入年龄" style="width: 100%; padding: 8px; margin-top: 5px;">
        </div>
        <div style="margin: 15px 0;">
            <label>手机号：</label>
            <input type="text" id="userPhone" placeholder="请输入手机号" style="width: 100%; padding: 8px; margin-top: 5px;">
        </div>
        <div class="modal-footer">
            <button class="btn btn-close" onclick="closeModal('userModal')">取消</button>
            <button class="btn btn-primary" onclick="submitUser()">确认</button>
        </div>
    </div>
</div>

<!-- 提示框 -->
<div class="toast" id="toast"></div>

<script>
    let chunkSize = 0;
    // 文件列表缓存
    let fileListCache = [];
    // 用户列表缓存 + 加载状态
    let userPageCache = null;
    let isUserLoading = false;
    let isFileLoading = false;

    // ===================== 通用工具函数 =====================
    function showToast(msg, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = `toast toast-${type}`;
        toast.style.display = 'block';
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }

    function formatFileSize(bytes) {
        if (bytes === 0 || !bytes) return '0B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (bytes / Math.pow(k, i)).toFixed(2) + sizes[i];
    }

    function formatDateTime(dateStr) {
        if (!dateStr) return '未知时间';
        try {
            const date = new Date(isNaN(dateStr) ? dateStr : (typeof dateStr === 'string' ? parseInt(dateStr) : dateStr));
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        } catch (e) {
            return '未知时间';
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // ===================== 标签页切换 =====================
    function switchTab(tabName) {
        document.querySelectorAll('.tab-bar li').forEach(li => li.classList.remove('active'));
        document.querySelector(`.tab-bar li[onclick="switchTab('${tabName}')"]`).classList.add('active');

        document.querySelectorAll('.list-container').forEach(c => c.classList.remove('active'));
        const containerId = `${tabName.split('-')[0]}-container`;
        document.getElementById(containerId).classList.add('active');

        document.getElementById('file-operation').style.display = tabName === 'file-tab' ? 'flex' : 'none';
        document.getElementById('user-operation').style.display = tabName === 'user-tab' ? 'flex' : 'none';

        if (tabName === 'file-tab' && !isFileLoading && fileListCache.length === 0) {
            loadFileList();
        } else if (tabName === 'user-tab') {
            // 如果已经有缓存，直接用缓存渲染，不必重拉
            if (userPageCache && !isUserLoading) {
                renderUserList(userPageCache.list || []);
                renderPageControl(userPageCache.pageNum, userPageCache.pageSize, userPageCache.total);
            } else if (!isUserLoading) {
                listUserByPage(1, 10);
            }
        }
    }

    // ===================== 文件管理 =====================
    function loadFileList(fileName = '') {
        const fileTableBody = document.getElementById('fileTableBody');
        isFileLoading = true;
        fileTableBody.innerHTML = '<tr><td colspan="5" class="empty-data">加载中...</td></tr>';

        let url = '/file/list';
        if (fileName.trim() !== '') {
            url = `/file/search?fileName=${encodeURIComponent(fileName.trim())}`;
        }

        fetch(url)
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP请求失败：${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                if (!data || typeof data.code === 'undefined') {
                    throw new Error('后端返回数据格式错误');
                }
                if (data.code !== 200) {
                    throw new Error(data.msg || '文件列表查询失败');
                }
                fileListCache = Array.isArray(data.data) ? data.data : [];
                renderFileList(fileListCache);
            })
            .catch(err => {
                showToast(`文件加载失败：${err.message}`, 'error');
                fileTableBody.innerHTML = '<tr><td colspan="5" class="empty-data">加载失败</td></tr>';
                console.error('文件列表加载错误：', err);
            })
            .finally(() => {
                isFileLoading = false;
            });
    }

    function renderFileList(fileList) {
        const fileTableBody = document.getElementById('fileTableBody');
        if (!fileList || fileList.length === 0) {
            fileTableBody.innerHTML = '<tr><td colspan="5" class="empty-data">暂无文件</td></tr>';
            return;
        }
        fileTableBody.innerHTML = fileList.map(file => `
            <tr>
                <td>${file.fileName || '未知文件名'}</td>
                <td>${file.fileType || '未知类型'}</td>
                <td>${formatFileSize(file.fileSize)}</td>
                <td>${formatDateTime(file.uploadTime)}</td>
                <td>
                    <button class="btn btn-primary">下载</button>
                    <button class="btn btn-danger" onclick="deleteFile('${file.fileId || ''}')">删除</button>
                </td>
            </tr>
        `).join('');
    }

    function showFileName() {
        const fileInput = document.getElementById('fileInput');
        document.getElementById('fileNameTip').textContent = fileInput.files.length > 0 ? fileInput.files[0].name : '未选择文件';
    }

    function openUploadModal() {
        const modal = document.getElementById('uploadModal');
        modal.style.display = 'flex';
        document.getElementById('fileInput').value = '';
        document.getElementById('fileNameTip').textContent = '未选择文件';
    }

    function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput.files.length === 0) {
            showToast('请选择文件', 'error');
            return;
        }
        const file = fileInput.files[0];

        const tempFile = {
            fileName: file.name,
            fileType: file.type || '未知类型',
            fileSize: file.size,
            uploadTime: new Date().toLocaleString(),
            fileId: 'temp_' + Date.now()
        };
        fileListCache.unshift(tempFile);
        renderFileList(fileListCache);

        const formData = new FormData();
        formData.append('file', file);
        fetch('/file/upload', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (!data || data.code !== 200) {
                    throw new Error(data.msg || '文件上传失败');
                }
                showToast('文件上传成功', 'success');
                fileListCache = fileListCache.map(item =>
                    item.fileId === tempFile.fileId ? (data.data || item) : item
                );
                renderFileList(fileListCache);
                closeModal('uploadModal');
            })
            .catch(err => {
                fileListCache = fileListCache.filter(item => item.fileId !== tempFile.fileId);
                renderFileList(fileListCache);
                showToast(`上传失败：${err.message}`, 'error');
                closeModal('uploadModal');
                console.error('文件上传错误：', err);
            });
    }

    function deleteFile(fileId) {
        if (!fileId || fileId.startsWith('temp_')) {
            showToast('文件ID无效', 'error');
            return;
        }
        if (!confirm('确定删除该文件吗？')) {
            return;
        }

        const oldList = [...fileListCache];
        fileListCache = fileListCache.filter(item => item.fileId !== fileId);
        renderFileList(fileListCache);

        fetch(`/file/${fileId}`, {
            method: 'DELETE'
        })
            .then(res => res.json())
            .then(data => {
                if (!data || data.code !== 200) {
                    throw new Error(data.msg || '文件删除失败');
                }
                showToast('文件删除成功', 'success');
            })
            .catch(err => {
                fileListCache = oldList;
                renderFileList(fileListCache);
                showToast(`删除失败：${err.message}`, 'error');
                console.error('文件删除错误：', err);
            });
    }

    function searchFile() {
        const fileName = document.getElementById('fileSearchInput').value.trim();
        const filteredList = fileName
            ? fileListCache.filter(file => file.fileName && file.fileName.includes(fileName))
            : fileListCache;
        renderFileList(filteredList);
    }

    // ===================== 用户管理 =====================
    function listUserByPage(pageNum = 1, pageSize = 5) {
        const userTableBody = document.getElementById('userTableBody');

        isUserLoading = true;
        userTableBody.innerHTML = '<tr><td colspan="5" class="empty-data">加载中...</td></tr>';

        fetch('/user/page', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ pageNum: pageNum, pageSize: pageSize })
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP请求失败：${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                if (!data || data.code !== 200) {
                    throw new Error(data.msg || '用户列表查询失败');
                }
                const pageResult = data.data || {};
                const userList = Array.isArray(pageResult.list) ? pageResult.list : [];

                // 缓存分页结果
                userPageCache = {
                    list: userList,
                    pageNum: pageResult.pageNum || pageNum,
                    pageSize: pageResult.pageSize || pageSize,
                    total: pageResult.total || 0
                };

                renderUserList(userList);
                renderPageControl(userPageCache.pageNum, userPageCache.pageSize, userPageCache.total);
            })
            .catch(err => {
                showToast(`用户加载失败：${err.message}`, 'error');
                userTableBody.innerHTML = '<tr><td colspan="5" class="empty-data">加载失败</td></tr>';
                console.error('用户列表加载错误：', err);
            })
            .finally(() => {
                isUserLoading = false;
            });
    }

    function renderUserList(userList) {
        const userTableBody = document.getElementById('userTableBody');
        if (!userList || userList.length === 0) {
            userTableBody.innerHTML = '<tr><td colspan="5" class="empty-data">暂无用户</td></tr>';
            return;
        }
        userTableBody.innerHTML = userList.map(user => `
            <tr>
                <td>${user.id || '未知ID'}</td>
                <td>${user.username || '未知用户名'}</td>
                <td>${user.age || '未知年龄'}</td>
                <td>${user.phone || '未知手机号'}</td>
                <td>
                    <button class="btn btn-primary" onclick="openUserModal('edit', '${user.id || ''}')">编辑</button>
                    <button class="btn btn-danger" onclick="deleteUser('${user.id || ''}')">删除</button>
                </td>
            </tr>
        `).join('');
    }

    function renderPageControl(pageNum, pageSize, total) {
        const pageControl = document.getElementById('pageControl');
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        pageControl.innerHTML = `
            <span>当前页：${pageNum} / 总页：${totalPages}，共${total}条数据</span>
            <button class="btn btn-primary" onclick="listUserByPage(${pageNum > 1 ? pageNum - 1 : 1}, ${pageSize})" ${pageNum === 1 ? 'disabled' : ''}>上一页</button>
            <button class="btn btn-primary" onclick="listUserByPage(${pageNum < totalPages ? pageNum + 1 : totalPages}, ${pageSize})" ${pageNum === totalPages ? 'disabled' : ''}>下一页</button>
        `;
    }

    function openUserModal(type = 'add', userId = '') {
        const modal = document.getElementById('userModal');
        const modalTitle = document.getElementById('userModalTitle');
        const userIdInput = document.getElementById('userId');
        const userNameInput = document.getElementById('userName');
        const userAgeInput = document.getElementById('userAge');
        const userPhoneInput = document.getElementById('userPhone');

        userNameInput.value = '';
        userAgeInput.value = '';
        userPhoneInput.value = '';
        userIdInput.value = '';

        if (type === 'add') {
            modalTitle.textContent = '新增用户';
        } else if (type === 'edit' && userId) {
            modalTitle.textContent = '编辑用户';
            userIdInput.value = userId;
            fetch(`/user/${userId}`)
                .then(res => res.json())
                .then(data => {
                    if (!data || data.code !== 200) {
                        throw new Error(data.msg || '用户详情查询失败');
                    }
                    const user = data.data || {};
                    userNameInput.value = user.username || '';
                    userAgeInput.value = user.age || '';
                    userPhoneInput.value = user.phone || '';
                })
                .catch(err => {
                    showToast(`获取用户信息失败：${err.message}`, 'error');
                    console.error('用户详情查询错误：', err);
                });
        }

        modal.style.display = 'flex';
    }

    function submitUser() {
        const userId = document.getElementById('userId').value;
        const userName = document.getElementById('userName').value.trim();
        const userAge = document.getElementById('userAge').value.trim();
        const userPhone = document.getElementById('userPhone').value.trim();

        if (!userName || !userAge || !userPhone) {
            showToast('请填写完整信息', 'error');
            return;
        }
        if (isNaN(userAge) || userAge < 0 || userAge > 150) {
            showToast('年龄格式错误（0-150）', 'error');
            return;
        }
        if (!/^1[3-9]\d{9}$/.test(userPhone)) {
            showToast('手机号格式错误（11位手机号）', 'error');
            return;
        }

        const userData = {
            username: userName,
            age: parseInt(userAge),
            phone: userPhone
        };
        if (userId) {
            userData.id = userId;
        }

        const url = userId ? '/user/update' : '/user/add';
        const method = userId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP请求失败：${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                if (!data || data.code !== 200) {
                    throw new Error(data.msg || (userId ? '用户编辑失败' : '用户新增失败'));
                }
                showToast(userId ? '用户编辑成功' : '用户新增成功', 'success');
                closeModal('userModal');
                listUserByPage(1, 10);
            })
            .catch(err => {
                showToast(`操作失败：${err.message}`, 'error');
                console.error('用户操作错误：', err);
            });
    }

    function deleteUser(id) {
        if (!id) {
            showToast('用户ID无效', 'error');
            return;
        }
        if (!confirm('确定删除该用户吗？')) {
            return;
        }

        fetch(`/user/${id}`, {
            method: 'DELETE'
        })
            .then(res => res.json())
            .then(data => {
                if (!data || data.code !== 200) {
                    throw new Error(data.msg || '用户删除失败');
                }
                showToast('用户删除成功', 'success');
                listUserByPage(1, 10);
            })
            .catch(err => {
                showToast(`删除失败：${err.message}`, 'error');
                console.error('用户删除错误：', err);
            });
    }

    function searchUser() {
        const usernameKeyword = document.getElementById('userSearchInput').value.trim();
        if (!usernameKeyword) {
            // 清空搜索关键字时，回到分页列表
            if (userPageCache) {
                renderUserList(userPageCache.list || []);
                renderPageControl(userPageCache.pageNum, userPageCache.pageSize, userPageCache.total);
            } else {
                listUserByPage(1, 10);
            }
            return;
        }
        fetch(`/user/search?usernameKeyword=${encodeURIComponent(usernameKeyword)}`)
            .then(res => res.json())
            .then(data => {
                if (!data || data.code !== 200) {
                    throw new Error(data.msg || '用户搜索失败');
                }
                const userList = Array.isArray(data.data) ? data.data : [];
                renderUserList(userList);
                document.getElementById('pageControl').innerHTML = '';
            })
            .catch(err => {
                showToast(`搜索失败：${err.message}`, 'error');
                console.error('用户搜索错误：', err);
            });
    }

    // ===================== 页面初始化 =====================
    window.onload = function() {
        loadFileList();
        fetch('/file/chunk/size')
            .then(res => res.json())
            .then(data => {
                chunkSize = data?.data || 0;
            })
            .catch(err => {
                console.log('未获取到分片大小，将使用普通上传：', err);
                chunkSize = 0;
            });
    };
</script>
</body>
</html>
